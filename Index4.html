<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Modifier les codes et image</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h2>Mettre à jour les codes + image</h2>

    <form id="adminForm" class="mb-3">
      <label class="form-label">Image (à téléverser) :</label>
      <input type="file" id="imageInput" accept="image/*" class="form-control mb-3" required>

      <label class="form-label">Code 1xBet :</label>
      <input type="text" id="code1xbet" class="form-control mb-2" required>

      <label class="form-label">Code Melbet :</label>
      <input type="text" id="codeMelbet" class="form-control mb-2" required>

      <label class="form-label">Code 1BetWinner :</label>
      <input type="text" id="codeWinner" class="form-control mb-2" required>

      <button type="submit" class="btn btn-primary mt-3">Mettre à jour</button>
    </form>

    <div id="status" class="alert d-none"></div>
  </div>

  <script>
    const binId = "681e6b2f8960c979a5965b05";
    const jsonBinApiKey = "$2a$10$ECzsch031CIPF2dPbjNRruDYZyMcRRAEw7nRFrw0mOulZ0lndbYG6";
    const imgbbApiKey = "47e4dc9cfad5e953e21c1aa660986560";

    document.getElementById("adminForm").addEventListener("submit", function(e) {
      e.preventDefault();
      const imageFile = document.getElementById("imageInput").files[0];

      if (!imageFile) {
        alert("Veuillez sélectionner une image.");
        return;
      }

      const reader = new FileReader();
      reader.onloadend = function () {
        const base64Image = reader.result.split(',')[1];

        // Étape 1 : téléverser l'image vers imgbb
        fetch("https://api.imgbb.com/1/upload?key=" + imgbbApiKey, {
          method: "POST",
          body: new URLSearchParams({
            image: base64Image
          })
        })
        .then(res => res.json())
        .then(imgData => {
          const imageUrl = imgData.data.url;

          // Étape 2 : mettre à jour JSONBin
          const data = {
            imageUrl: imageUrl,
            codes: {
              "1xbet": document.getElementById("code1xbet").value,
              "melbet": document.getElementById("codeMelbet").value,
              "1betwinner": document.getElementById("codeWinner").value
            }
          };

          return fetch("https://api.jsonbin.io/v3/b/" + binId, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": jsonBinApiKey
            },
            body: JSON.stringify(data)
          });
        })
        .then(() => {
          const status = document.getElementById("status");
          status.className = "alert alert-success";
          status.textContent = "Codes et image mis à jour avec succès !";
          status.classList.remove("d-none");
        })
        .catch(() => {
          const status = document.getElementById("status");
          status.className = "alert alert-danger";
          status.textContent = "Erreur pendant la mise à jour.";
          status.classList.remove("d-none");
        });
      };

      reader.readAsDataURL(imageFile);
    });
  </script>
</body>
</html>